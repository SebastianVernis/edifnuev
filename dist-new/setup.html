<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configurar Edificio - ChispartBuilding</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --secondary: #10B981;
      --dark: #1F2937;
      --light: #F9FAFB;
      --gray: #6B7280;
      --danger: #EF4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .progress-bar {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #E5E7EB;
      z-index: 0;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #E5E7EB;
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem;
      font-weight: bold;
    }

    .step.completed .step-icon {
      background: var(--secondary);
      color: white;
    }

    .step.active .step-icon {
      background: var(--primary);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--gray);
    }

    .form-card {
      background: white;
      padding: 2.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-card h1 {
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .form-card .subtitle {
      color: var(--gray);
      margin-bottom: 2rem;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--dark);
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .section-title i {
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--dark);
      font-weight: 500;
    }

    label .optional {
      color: var(--gray);
      font-weight: normal;
      font-size: 0.875rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #E5E7EB;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .help-text {
      font-size: 0.875rem;
      color: var(--gray);
      margin-top: 0.25rem;
    }

    .smtp-guide {
      background: #EFF6FF;
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .smtp-guide summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .smtp-guide ul {
      margin-left: 1.5rem;
      color: var(--gray);
    }

    .file-upload {
      border: 2px dashed #E5E7EB;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: var(--light);
    }

    .file-upload input {
      display: none;
    }

    .file-upload i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .file-list {
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      background: var(--light);
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .file-item button {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .patrimony-list {
      border: 2px solid #E5E7EB;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 0.5rem;
    }

    .patrimony-item {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #E5E7EB;
    }

    .patrimony-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .patrimony-item input {
      margin-bottom: 0;
    }

    .btn-remove {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      width: 35px;
      height: 35px;
    }

    .btn-add {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .btn {
      width: 100%;
      padding: 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: none;
    }

    .alert.error {
      background: #FEE2E2;
      color: var(--danger);
      display: block;
    }

    .alert.success {
      background: #D1FAE5;
      color: var(--secondary);
      display: block;
    }

    .info-box {
      background: #EFF6FF;
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 0.5rem;
    }

    .info-box i {
      color: var(--primary);
      margin-right: 0.5rem;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .steps {
        flex-direction: column;
        gap: 1rem;
      }

      .steps::before {
        display: none;
      }

      body {
        padding: 1rem 0.5rem;
      }
    }
  </style>
  <script src="/config.js"></script>
</head>
<body>
  <div class="container">
    <div class="progress-bar">
      <div class="steps">
        <div class="step completed">
          <div class="step-icon">✓</div>
          <div class="step-label">Registro</div>
        </div>
        <div class="step completed">
          <div class="step-icon">✓</div>
          <div class="step-label">Verificación</div>
        </div>
        <div class="step completed">
          <div class="step-icon">✓</div>
          <div class="step-label">Pago</div>
        </div>
        <div class="step active">
          <div class="step-icon">4</div>
          <div class="step-label">Configuración</div>
        </div>
      </div>
    </div>

    <div class="form-card">
      <h1>Configura tu edificio</h1>
      <p class="subtitle">Completa la información de tu condominio para comenzar</p>

      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <strong>Último paso:</strong> Proporciona toda la información para configurar tu sistema. Los campos opcionales pueden completarse después.
      </div>

      <div id="planInfo" class="info-box" style="background: #EFF6FF; border-left-color: var(--primary); margin-bottom: 1rem;">
        <i class="fas fa-check-circle"></i>
        <strong>Plan seleccionado:</strong> <span id="planName"></span><br>
        <strong>Unidades disponibles:</strong> <span id="planUnits"></span>
      </div>

      <div id="alert" class="alert"></div>

      <form id="setupForm">
        <!-- Información del Edificio -->
        <div class="section-title">
          <i class="fas fa-building"></i>
          Información del Edificio
        </div>

        <div class="form-group">
          <label for="buildingName">Nombre del edificio/condominio *</label>
          <input type="text" id="buildingName" name="buildingName" required>
        </div>

        <div class="form-group">
          <label for="address">Dirección completa *</label>
          <textarea id="address" name="address" required></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="totalUnits">Total de unidades</label>
            <input type="number" id="totalUnits" name="totalUnits" min="1" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
            <p class="help-text">Definido por tu plan seleccionado</p>
          </div>

          <div class="form-group">
            <label for="buildingType">Tipo de propiedad *</label>
            <select id="buildingType" name="buildingType" required>
              <option value="edificio">Edificio</option>
              <option value="condominio">Condominio horizontal</option>
              <option value="residencial">Residencial</option>
              <option value="mixto">Uso mixto</option>
            </select>
          </div>
        </div>

        <!-- Información del Administrador -->
        <div class="section-title">
          <i class="fas fa-user-shield"></i>
          Información del Administrador
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="adminName">Nombre completo *</label>
            <input type="text" id="adminName" name="adminName" required>
          </div>

          <div class="form-group">
            <label for="adminPhone">Teléfono *</label>
            <input type="tel" id="adminPhone" name="adminPhone" required placeholder="5512345678">
          </div>
        </div>

        <div class="form-group">
          <label for="adminPassword">Contraseña de administrador *</label>
          <input type="password" id="adminPassword" name="password" minlength="6" required>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirmar contraseña *</label>
          <input type="password" id="confirmPassword" name="confirmPassword" minlength="6" required>
        </div>


        <!-- Documentos -->
        <div class="section-title">
          <i class="fas fa-file-upload"></i>
          Documentos <span class="optional">(Todos opcionales)</span>
        </div>

        <div class="form-group">
          <label>Acta constitutiva</label>
          <div class="file-upload" id="actaUpload">
            <input type="file" id="actaFile" accept=".pdf,.jpg,.jpeg,.png">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click para subir o arrastra aquí</p>
            <p class="help-text">PDF, JPG o PNG (máx 5MB)</p>
          </div>
          <div class="file-list" id="actaList"></div>
        </div>

        <div class="form-group">
          <label>Registro ante PROSOC/Autoridad</label>
          <div class="file-upload" id="prosocUpload">
            <input type="file" id="prosocFile" accept=".pdf,.jpg,.jpeg,.png">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click para subir o arrastra aquí</p>
          </div>
          <div class="file-list" id="prosocList"></div>
        </div>

        <div class="form-group">
          <label>Información bancaria</label>
          <div class="file-upload" id="bancoUpload">
            <input type="file" id="bancoFile" accept=".pdf,.jpg,.jpeg,.png">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click para subir o arrastra aquí</p>
          </div>
          <div class="file-list" id="bancoList"></div>
        </div>

        <!-- Reglamentos y Políticas -->
        <div class="section-title">
          <i class="fas fa-file-contract"></i>
          Reglamentos y Políticas
        </div>

        <div class="form-group">
          <label for="reglamento">Reglamento interno del condominio</label>
          <p class="help-text">Puedes subir tu propio reglamento o usar una plantilla</p>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <button type="button" class="btn-add" style="flex: 1;" onclick="useTemplate('basico')">
              <i class="fas fa-file-alt"></i> Usar plantilla básica
            </button>
            <button type="button" class="btn-add" style="flex: 1; background: var(--primary);" onclick="useTemplate('completo')">
              <i class="fas fa-file-contract"></i> Usar plantilla completa
            </button>
          </div>
          <div class="file-upload" id="reglamentoUpload">
            <input type="file" id="reglamentoFile" accept=".pdf,.doc,.docx">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>O sube tu propio reglamento</p>
            <p class="help-text">PDF, DOC o DOCX (máx 10MB)</p>
          </div>
          <div class="file-list" id="reglamentoList"></div>
          <div id="reglamentoTemplate" style="display: none; margin-top: 1rem;">
            <textarea id="reglamentoText" rows="10" placeholder="El reglamento aparecerá aquí..."></textarea>
          </div>
        </div>

        <div class="form-group">
          <label for="privacyPolicy">Políticas de privacidad</label>
          <p class="help-text">Define cómo se manejarán los datos personales de los residentes</p>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <button type="button" class="btn-add" style="flex: 1;" onclick="usePrivacyTemplate()">
              <i class="fas fa-shield-alt"></i> Usar plantilla de privacidad
            </button>
          </div>
          <textarea id="privacyPolicy" rows="8" placeholder="Define las políticas de privacidad..."></textarea>
        </div>

        <!-- Patrimonios/Fondos -->
        <div class="section-title">
          <i class="fas fa-piggy-bank"></i>
          Patrimonios y Fondos
        </div>

        <div class="form-group">
          <label>Fondos disponibles</label>
          <p class="help-text">Agrega los fondos o patrimonios existentes del condominio</p>
          <div class="patrimony-list" id="patrimonyList">
            <div class="patrimony-item">
              <input type="text" placeholder="Nombre del fondo" data-patrimony-name>
              <input type="number" placeholder="Monto inicial" step="0.01" data-patrimony-amount>
              <button type="button" class="btn-remove" onclick="removePatrimony(this)">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <button type="button" class="btn-add" onclick="addPatrimony()">
            <i class="fas fa-plus"></i> Agregar fondo
          </button>
        </div>

        <div class="form-group">
          <label for="fondoIngresos">Fondo para Ingresos de Cuotas</label>
          <select id="fondoIngresos" name="fondoIngresos">
            <option value="">Seleccionar después</option>
          </select>
          <p class="help-text">El fondo seleccionado recibirá automáticamente los pagos de cuotas. Puedes cambiarlo después en Configuración.</p>
        </div>

        <!-- Cuotas -->
        <div class="section-title">
          <i class="fas fa-dollar-sign"></i>
          Configuración de Cuotas
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="monthlyFee">Cuota mensual ordinaria (MXN) *</label>
            <input type="number" id="monthlyFee" name="monthlyFee" min="0" step="0.01" required>
            <p class="help-text">Monto regular mensual por unidad</p>
          </div>

          <div class="form-group">
            <label for="extraordinaryFee">Cuota extraordinaria (MXN) <span class="optional">(opcional)</span></label>
            <input type="number" id="extraordinaryFee" name="extraordinaryFee" min="0" step="0.01">
            <p class="help-text">Para proyectos especiales</p>
          </div>
        </div>

        <div class="form-group">
          <label for="cutoffDay">Día de corte mensual *</label>
          <input type="number" id="cutoffDay" name="cutoffDay" min="1" max="31" value="1" required>
          <p class="help-text">Día del mes en que vencen las cuotas</p>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="paymentDueDays">Días de gracia para pago *</label>
            <input type="number" id="paymentDueDays" name="paymentDueDays" min="0" max="30" value="5" required>
            <p class="help-text">Días después del corte antes de aplicar mora</p>
          </div>

          <div class="form-group">
            <label for="lateFeePercent">Recargo por mora (%) *</label>
            <input type="number" id="lateFeePercent" name="lateFeePercent" min="0" max="100" step="0.1" value="2" required>
            <p class="help-text">Porcentaje de recargo mensual por mora</p>
          </div>
        </div>

        <div class="form-group">
          <label for="paymentPolicies">Políticas de vencimiento de pagos</label>
          <p class="help-text">Define las reglas y consecuencias de pagos vencidos</p>
          <div style="margin-bottom: 1rem;">
            <button type="button" class="btn-add" onclick="usePaymentPolicyTemplate()">
              <i class="fas fa-receipt"></i> Usar plantilla de políticas de pago
            </button>
          </div>
          <textarea id="paymentPolicies" rows="8" placeholder="Define las políticas de vencimiento..."></textarea>
        </div>

        <button type="submit" class="btn" id="submitBtn">
          <i class="fas fa-check-circle"></i>
          Completar configuración
        </button>
      </form>
    </div>
  </div>

  <script>
    const email = localStorage.getItem('onboarding_email');
    const buildingNameStorage = localStorage.getItem('building_name');
    const selectedPlan = localStorage.getItem('onboarding_plan');

    if (!email) {
      window.location.href = '/register';
    }

    // Pre-fill building name if available
    if (buildingNameStorage) {
      document.getElementById('buildingName').value = buildingNameStorage;
    }

    // Define plans with maxUnits
    const PLANS = {
      basico: { name: 'Plan Básico', maxUnits: 20 },
      profesional: { name: 'Plan Profesional', maxUnits: 50 },
      empresarial: { name: 'Plan Empresarial', maxUnits: 200 },
      personalizado: { name: 'Plan Personalizado', maxUnits: -1 }
    };

    // Get total units from plan or custom package
    let totalUnits = 20; // Default
    
    if (selectedPlan) {
      const customPackage = localStorage.getItem('custom_package');
      
      if (selectedPlan === 'personalizado' && customPackage) {
        // Use units from custom package
        const pkg = JSON.parse(customPackage);
        totalUnits = pkg.units || 20;
      } else if (PLANS[selectedPlan]) {
        // Use maxUnits from selected plan
        totalUnits = PLANS[selectedPlan].maxUnits;
      }
    }

    // Set the total units field (readonly)
    document.getElementById('totalUnits').value = totalUnits;

    // Update plan info display
    const planName = selectedPlan ? PLANS[selectedPlan]?.name || 'Plan Profesional' : 'Plan Profesional';
    const planUnitsText = totalUnits === -1 ? 'Ilimitadas' : `${totalUnits} unidades`;
    
    document.getElementById('planName').textContent = planName;
    document.getElementById('planUnits').textContent = planUnitsText;

    // File upload handlers
    function setupFileUpload(uploadId, inputId, listId) {
      const uploadDiv = document.getElementById(uploadId);
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);

      uploadDiv.addEventListener('click', () => input.click());

      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span><i class="fas fa-file"></i> ${file.name}</span>
            <button type="button" onclick="this.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          `;
          list.innerHTML = '';
          list.appendChild(fileItem);
        }
      });

      // Drag and drop
      uploadDiv.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadDiv.style.borderColor = 'var(--primary)';
      });

      uploadDiv.addEventListener('dragleave', () => {
        uploadDiv.style.borderColor = '#E5E7EB';
      });

      uploadDiv.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadDiv.style.borderColor = '#E5E7EB';
        const file = e.dataTransfer.files[0];
        if (file) {
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          input.files = dataTransfer.files;
          input.dispatchEvent(new Event('change'));
        }
      });
    }

    setupFileUpload('actaUpload', 'actaFile', 'actaList');
    setupFileUpload('prosocUpload', 'prosocFile', 'prosocList');
    setupFileUpload('bancoUpload', 'bancoFile', 'bancoList');
    setupFileUpload('reglamentoUpload', 'reglamentoFile', 'reglamentoList');

    // Patrimony management
    // Actualizar select de fondos
    function updateFondosSelect() {
      const fondoIngresosSelect = document.getElementById('fondoIngresos');
      const patrimonyItems = document.querySelectorAll('.patrimony-item');
      
      const currentValue = fondoIngresosSelect.value;
      fondoIngresosSelect.innerHTML = '<option value="">Seleccionar fondo...</option>';
      
      patrimonyItems.forEach((item, idx) => {
        const nameInput = item.querySelector('[data-patrimony-name]');
        const name = nameInput?.value || '';
        
        if (name.trim()) {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = name;
          fondoIngresosSelect.appendChild(option);
        }
      });
      
      if (currentValue) {
        fondoIngresosSelect.value = currentValue;
      }
    }

    function addPatrimony() {
      const list = document.getElementById('patrimonyList');
      const item = document.createElement('div');
      item.className = 'patrimony-item';
      item.innerHTML = `
        <input type="text" placeholder="Nombre del fondo" data-patrimony-name>
        <input type="number" placeholder="Monto inicial" step="0.01" data-patrimony-amount>
        <button type="button" class="btn-remove" onclick="removePatrimony(this)">
          <i class="fas fa-times"></i>
        </button>
      `;
      list.appendChild(item);
      
      const nameInput = item.querySelector('[data-patrimony-name]');
      nameInput.addEventListener('input', updateFondosSelect);
      updateFondosSelect();
    }

    function removePatrimony(btn) {
      const list = document.getElementById('patrimonyList');
      if (list.children.length > 1) {
        btn.parentElement.remove();
        updateFondosSelect();
      }
    }
    
    // Inicializar listeners
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-patrimony-name]').forEach(input => {
        input.addEventListener('input', updateFondosSelect);
      });
      updateFondosSelect();
    });

    // Templates
    const TEMPLATES = {
      reglamento_basico: `REGLAMENTO INTERNO DEL CONDOMINIO

1. DISPOSICIONES GENERALES
- Este reglamento establece las normas de convivencia del condominio.
- Todos los residentes, propietarios e inquilinos deben cumplir estas disposiciones.
- El incumplimiento puede derivar en sanciones establecidas por la asamblea.

2. HORARIOS Y RUIDOS
- Horario de silencio: 22:00 hrs a 08:00 hrs
- Prohibidos ruidos molestos que perturben la tranquilidad
- Trabajos de construcción/remodelación: Lunes a Viernes de 09:00 a 18:00 hrs

3. ÁREAS COMUNES
- Respetar el uso de áreas comunes
- Mantener limpieza y orden
- Reservar espacios según procedimiento establecido

4. ESTACIONAMIENTO
- Respetar cajones asignados
- Prohibido estacionar en áreas de circulación
- Velocidad máxima: 10 km/h

5. MASCOTAS
- Permitidas con registro previo
- Obligatorio uso de correa en áreas comunes
- Propietario responsable de limpieza
- Prohibido dejar mascotas sin supervisión

6. SEGURIDAD
- No proporcionar acceso a desconocidos
- Reportar actividades sospechosas
- Mantener cerradas puertas de acceso

7. PAGOS Y CUOTAS
- Pagar cuotas en tiempo y forma
- Notificar cambios de propietario/inquilino
- Mantener actualizada información de contacto`,

      reglamento_completo: `REGLAMENTO INTERNO DEL CONDOMINIO
Versión Completa

TÍTULO I - DISPOSICIONES GENERALES

Artículo 1. Objeto y Ámbito
El presente reglamento tiene por objeto establecer las normas de convivencia, uso y conservación de las áreas comunes y privativas del condominio, así como los derechos y obligaciones de propietarios, residentes y visitantes.

Artículo 2. Obligatoriedad
Este reglamento es de observancia obligatoria para todos los propietarios, arrendatarios, residentes, visitantes y personal que preste servicios en el condominio.

TÍTULO II - ADMINISTRACIÓN

Artículo 3. Órganos de Administración
- Asamblea General de Condóminos
- Comité de Administración
- Administrador

Artículo 4. Cuotas de Mantenimiento
Los propietarios están obligados a cubrir las cuotas ordinarias y extraordinarias aprobadas en asamblea, en las fechas establecidas.

TÍTULO III - USO DE ÁREAS PRIVATIVAS Y COMUNES

Artículo 5. Áreas Privativas
- Uso exclusivo del propietario
- Prohibido realizar modificaciones exteriores sin autorización
- Mantener en buen estado de conservación

Artículo 6. Áreas Comunes
- Accesos, pasillos, escaleras, elevadores
- Estacionamientos de visitas
- Salones, áreas verdes, instalaciones deportivas
- Azoteas, cuartos de máquinas

Artículo 7. Horarios
- Silencio: 22:00 a 08:00 hrs
- Construcción: Lunes a Viernes 09:00 a 18:00 hrs, Sábados 10:00 a 14:00 hrs
- Uso de áreas comunes: 07:00 a 22:00 hrs

TÍTULO IV - CONVIVENCIA

Artículo 8. Ruidos y Molestias
Prohibido generar ruidos, vibraciones u olores que molesten a los vecinos.

Artículo 9. Mascotas
- Permitidas con registro
- Obligatorio vacunación y desparasitación
- Uso de correa en áreas comunes
- Prohibido en áreas de juegos infantiles y albercas

Artículo 10. Seguridad
- No dar acceso a desconocidos
- Registrar visitantes en control de acceso
- Reportar actividades sospechosas

TÍTULO V - SANCIONES

Artículo 11. Tipos de Sanciones
- Amonestación verbal
- Amonestación escrita
- Multas económicas
- Suspensión de servicios
- Acciones legales

TÍTULO VI - DISPOSICIONES FINALES

Artículo 12. Modificaciones
Este reglamento puede ser modificado por la Asamblea General con el voto favorable del 75% de los condóminos.`,

      privacidad: `POLÍTICAS DE PRIVACIDAD Y PROTECCIÓN DE DATOS

Última actualización: ${new Date().toLocaleDateString('es-MX')}

1. RESPONSABLE DEL TRATAMIENTO
El condominio es responsable del tratamiento de los datos personales recabados.

2. DATOS RECOPILADOS
- Datos de identificación (nombre, domicilio, teléfono, email)
- Datos patrimoniales (estado de cuenta, pagos)
- Datos de vehículos y mascotas
- Registros de acceso y visitantes

3. FINALIDADES
- Administración del condominio
- Comunicación con residentes
- Cobranza de cuotas
- Seguridad del inmueble
- Cumplimiento de obligaciones legales

4. COMPARTICIÓN DE DATOS
Los datos personales no serán compartidos con terceros, excepto:
- Autoridades competentes cuando sea legalmente requerido
- Proveedores de servicios bajo acuerdos de confidencialidad

5. MEDIDAS DE SEGURIDAD
Se implementan medidas de seguridad físicas, técnicas y administrativas para proteger los datos personales.

6. DERECHOS ARCO
Los titulares tienen derecho a:
- Acceder a sus datos personales
- Rectificar datos inexactos
- Cancelar datos cuando corresponda
- Oponerse al tratamiento

7. RETENCIÓN
Los datos se conservarán durante el tiempo necesario para cumplir las finalidades y obligaciones legales.

8. CONTACTO
Para ejercer derechos ARCO o consultas sobre privacidad, contactar al administrador del condominio.`,

      pago_vencimiento: `POLÍTICAS DE VENCIMIENTO Y MORA EN PAGOS

1. FECHAS DE PAGO
- Las cuotas de mantenimiento vencen el día [DÍA] de cada mes
- Plazo de gracia: [DÍAS] días naturales sin recargo
- Después del plazo de gracia se aplican recargos

2. RECARGOS POR MORA
- Tasa de recargo: [PORCENTAJE]% mensual sobre saldo vencido
- El recargo se aplica automáticamente
- Se calculan intereses sobre intereses vencidos

3. CONSECUENCIAS DE FALTA DE PAGO

30 días de atraso:
- Recordatorio por email y/o teléfono
- Suspensión de acceso a áreas comunes recreativas

60 días de atraso:
- Notificación formal por escrito
- Suspensión de servicios no esenciales
- Inicio de proceso de cobranza administrativa

90 días de atraso:
- Citatorio a asamblea de condóminos
- Inicio de procedimientos legales
- Posible embargo de unidad

4. CONVENIOS DE PAGO
- Disponibles para deudas mayores a 3 meses
- Requieren autorización del comité
- Incluyen plan de pagos con calendario definido
- Pago de gastos administrativos adicionales

5. ACLARACIONES
- Plazo de 5 días hábiles para presentar aclaraciones
- Presentar comprobantes de pago
- Respuesta en máximo 10 días hábiles

6. SUSPENSIÓN DE SERVICIOS
Servicios esenciales (agua, luz común, acceso básico) no se suspenden por ley.
Servicios suspendibles: áreas recreativas, eventos, gym, alberca, salones.

7. REINSTALACIÓN
Para reinstalar servicios suspendidos:
- Pago total de adeudo y recargos
- Pago de gastos de reconexión
- Firma de compromiso de pago puntual

8. RESPONSABILIDAD
El propietario es responsable del pago aún si la unidad está rentada.
En caso de venta, debe notificar y liquidar adeudos.`
    };

    function useTemplate(type) {
      const textarea = document.getElementById('reglamentoText');
      const templateDiv = document.getElementById('reglamentoTemplate');
      
      if (type === 'basico') {
        textarea.value = TEMPLATES.reglamento_basico;
      } else if (type === 'completo') {
        textarea.value = TEMPLATES.reglamento_completo;
      }
      
      templateDiv.style.display = 'block';
    }

    function usePrivacyTemplate() {
      document.getElementById('privacyPolicy').value = TEMPLATES.privacidad;
    }

    function usePaymentPolicyTemplate() {
      const cutoffDay = document.getElementById('cutoffDay').value || '[DÍA]';
      const dueDays = document.getElementById('paymentDueDays').value || '[DÍAS]';
      const lateFee = document.getElementById('lateFeePercent').value || '[PORCENTAJE]';
      
      let template = TEMPLATES.pago_vencimiento;
      template = template.replace('[DÍA]', cutoffDay);
      template = template.replace('[DÍAS]', dueDays);
      template = template.replace('[PORCENTAJE]', lateFee);
      
      document.getElementById('paymentPolicies').value = template;
    }

    // Form submission
    document.getElementById('setupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const alert = document.getElementById('alert');
      
      const password = document.getElementById('adminPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (password !== confirmPassword) {
        alert.className = 'alert error';
        alert.textContent = 'Las contraseñas no coinciden';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Configurando...';

      // Collect patrimonies
      const patrimonies = [];
      document.querySelectorAll('.patrimony-item').forEach((item, index) => {
        const name = item.querySelector('[data-patrimony-name]').value;
        const amount = item.querySelector('[data-patrimony-amount]').value;
        if (name && amount) {
          patrimonies.push({ name, amount: parseFloat(amount), index });
        }
      });

      // Actualizar selector de fondo de ingresos
      const fondoIngresosSelect = document.getElementById('fondoIngresos');
      fondoIngresosSelect.innerHTML = '<option value="">Seleccionar fondo...</option>';
      patrimonies.forEach((p, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = p.name;
        fondoIngresosSelect.appendChild(option);
      });
      
      const data = {
        email,
        adminPassword: password,
        adminData: {
          name: document.getElementById('adminName').value,
          phone: document.getElementById('adminPhone').value
        },
        buildingData: {
          name: document.getElementById('buildingName').value,
          address: document.getElementById('address').value,
          totalUnits: parseInt(document.getElementById('totalUnits').value),
          type: document.getElementById('buildingType').value,
          monthlyFee: parseFloat(document.getElementById('monthlyFee').value),
          extraordinaryFee: parseFloat(document.getElementById('extraordinaryFee').value) || 0,
          cutoffDay: parseInt(document.getElementById('cutoffDay').value),
          paymentDueDays: parseInt(document.getElementById('paymentDueDays').value),
          lateFeePercent: parseFloat(document.getElementById('lateFeePercent').value),
          reglamento: document.getElementById('reglamentoText').value,
          privacyPolicy: document.getElementById('privacyPolicy').value,
          paymentPolicies: document.getElementById('paymentPolicies').value
        },
        patrimonies: patrimonies,
        fondoIngresosIndex: parseInt(document.getElementById('fondoIngresos').value) || 0
      };

      try {
        const response = await fetch('/api/onboarding/complete-setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.ok) {
          alert.className = 'alert success';
          alert.textContent = '¡Configuración completada! Redirigiendo...';
          
          // Save credentials for activate page
          if (result.credentials) {
            localStorage.setItem('new_credentials', JSON.stringify(result.credentials));
          }
          
          // Clear onboarding data
          localStorage.removeItem('onboarding_email');
          localStorage.removeItem('onboarding_plan');
          localStorage.removeItem('building_name');
          localStorage.removeItem('custom_package');
          
          setTimeout(() => {
            window.location.href = '/activate';
          }, 2000);
        } else {
          throw new Error(result.msg || 'Error en la configuración');
        }
      } catch (error) {
        alert.className = 'alert error';
        alert.textContent = error.message;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Completar configuración';
      }
    });
  </script>
</body>
</html>
