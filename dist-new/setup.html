<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configurar Edificio - ChispartBuilding</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --secondary: #10B981;
      --dark: #1F2937;
      --light: #F9FAFB;
      --gray: #6B7280;
      --danger: #EF4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .progress-bar {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #E5E7EB;
      z-index: 0;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #E5E7EB;
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem;
      font-weight: bold;
    }

    .step.completed .step-icon {
      background: var(--secondary);
      color: white;
    }

    .step.active .step-icon {
      background: var(--primary);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      color: var(--gray);
    }

    .form-card {
      background: white;
      padding: 2.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-card h1 {
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .form-card .subtitle {
      color: var(--gray);
      margin-bottom: 2rem;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--dark);
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .section-title i {
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--dark);
      font-weight: 500;
    }

    label .optional {
      color: var(--gray);
      font-weight: normal;
      font-size: 0.875rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #E5E7EB;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .help-text {
      font-size: 0.875rem;
      color: var(--gray);
      margin-top: 0.25rem;
    }

    .smtp-guide {
      background: #EFF6FF;
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .smtp-guide summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .smtp-guide ul {
      margin-left: 1.5rem;
      color: var(--gray);
    }

    .file-upload {
      border: 2px dashed #E5E7EB;
      border-radius: 0.5rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: var(--light);
    }

    .file-upload input {
      display: none;
    }

    .file-upload i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .file-list {
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem;
      background: var(--light);
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .file-item button {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .patrimony-list {
      border: 2px solid #E5E7EB;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 0.5rem;
    }

    .patrimony-item {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #E5E7EB;
    }

    .patrimony-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .patrimony-item input {
      margin-bottom: 0;
    }

    .btn-remove {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      width: 35px;
      height: 35px;
    }

    .btn-add {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .btn {
      width: 100%;
      padding: 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }

    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: none;
    }

    .alert.error {
      background: #FEE2E2;
      color: var(--danger);
      display: block;
    }

    .alert.success {
      background: #D1FAE5;
      color: var(--secondary);
      display: block;
    }

    .info-box {
      background: #EFF6FF;
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 0.5rem;
    }

    .info-box i {
      color: var(--primary);
      margin-right: 0.5rem;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .steps {
        flex-direction: column;
        gap: 1rem;
      }

      .steps::before {
        display: none;
      }

      body {
        padding: 1rem 0.5rem;
      }
    }
  </style>
  <script src="/config.js"></script>
</head>
<body>
  <div class="container">
    <div class="progress-bar">
      <div class="steps">
        <div class="step completed">
          <div class="step-icon">‚úì</div>
          <div class="step-label">Registro</div>
        </div>
        <div class="step completed">
          <div class="step-icon">‚úì</div>
          <div class="step-label">Verificaci√≥n</div>
        </div>
        <div class="step completed">
          <div class="step-icon">‚úì</div>
          <div class="step-label">Pago</div>
        </div>
        <div class="step active">
          <div class="step-icon">4</div>
          <div class="step-label">Configuraci√≥n</div>
        </div>
      </div>
    </div>

    <div class="form-card">
      <h1>Configura tu edificio</h1>
      <p class="subtitle">Completa la informaci√≥n de tu condominio para comenzar</p>

      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <strong>√öltimo paso:</strong> Proporciona toda la informaci√≥n para configurar tu sistema. Los campos opcionales pueden completarse despu√©s.
      </div>

      <div id="planInfo" class="info-box" style="background: #EFF6FF; border-left-color: var(--primary); margin-bottom: 1rem;">
        <i class="fas fa-check-circle"></i>
        <strong>Plan seleccionado:</strong> <span id="planName"></span><br>
        <strong>Unidades disponibles:</strong> <span id="planUnits"></span>
      </div>

      <div id="alert" class="alert"></div>

      <form id="setupForm">
        <!-- Informaci√≥n del Edificio -->
        <div class="section-title">
          <i class="fas fa-building"></i>
          Informaci√≥n del Edificio
        </div>

        <div class="form-group">
          <label for="buildingName">Nombre del edificio/condominio *</label>
          <input type="text" id="buildingName" name="buildingName" required>
        </div>

        <div class="form-group">
          <label for="address">Direcci√≥n completa *</label>
          <textarea id="address" name="address" required></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="totalUnits">Total de unidades</label>
            <input type="number" id="totalUnits" name="totalUnits" min="1" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
            <p class="help-text">Definido por tu plan seleccionado</p>
          </div>

          <div class="form-group">
            <label for="buildingType">Tipo de propiedad *</label>
            <select id="buildingType" name="buildingType" required>
              <option value="edificio">Edificio</option>
              <option value="condominio">Condominio horizontal</option>
              <option value="residencial">Residencial</option>
              <option value="mixto">Uso mixto</option>
            </select>
          </div>
        </div>

        <div class="section-title" style="margin-top: 2rem;">
          <i class="fas fa-home"></i>
          Estructura de Departamentos
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="totalFloors">Cantidad de pisos *</label>
            <input type="number" id="totalFloors" name="totalFloors" min="1" required>
            <p class="help-text">Define cu√°ntos pisos/niveles tiene el edificio</p>
          </div>

          <div class="form-group">
            <label for="numberingStyle">Estilo de numeraci√≥n *</label>
            <select id="numberingStyle" name="numberingStyle" required>
              <option value="">Selecciona un estilo</option>
              <option value="dash">Con gui√≥n (4-1, 4-2, 4-3)</option>
              <option value="continuous">Continuo (401, 402, 403)</option>
            </select>
            <p class="help-text">Formato de numeraci√≥n de departamentos</p>
          </div>
        </div>

        <div id="departmentPreview" style="display: none; background: #F0F9FF; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; border-left: 4px solid var(--primary);">
          <h4 style="margin-bottom: 0.5rem; color: var(--dark);"><i class="fas fa-eye"></i> Vista Previa de Numeraci√≥n</h4>
          <p style="color: var(--gray); font-size: 0.875rem; margin-bottom: 0.5rem;">
            <strong>Distribuci√≥n:</strong> <span id="previewDistribution"></span>
          </p>
          <div id="previewDepartments" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
            <!-- Departamentos de ejemplo se mostrar√°n aqu√≠ -->
          </div>
        </div>

        <!-- Informaci√≥n del Administrador -->
        <div class="section-title">
          <i class="fas fa-user-shield"></i>
          Informaci√≥n del Administrador
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="adminName">Nombre completo *</label>
            <input type="text" id="adminName" name="adminName" required>
          </div>

          <div class="form-group">
            <label for="adminPhone">Tel√©fono *</label>
            <input type="tel" id="adminPhone" name="adminPhone" required placeholder="5512345678">
          </div>
        </div>

        <div class="form-group">
          <label for="adminPassword">Contrase√±a de administrador *</label>
          <input type="password" id="adminPassword" name="password" minlength="6" required>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirmar contrase√±a *</label>
          <input type="password" id="confirmPassword" name="confirmPassword" minlength="6" required>
        </div>


        <!-- Documentos -->
        <div class="section-title">
          <i class="fas fa-file-upload"></i>
          Documentos <span class="optional">(Todos opcionales)</span>
        </div>

        <div class="form-group">
          <label>Acta constitutiva</label>
          <div class="file-upload" id="actaUpload">
            <input type="file" id="actaFile" accept=".pdf,.jpg,.jpeg,.png">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click para subir o arrastra aqu√≠</p>
            <p class="help-text">PDF, JPG o PNG (m√°x 5MB)</p>
          </div>
          <div class="file-list" id="actaList"></div>
        </div>

        <div class="form-group">
          <label>Registro ante PROSOC/Autoridad</label>
          <div class="file-upload" id="prosocUpload">
            <input type="file" id="prosocFile" accept=".pdf,.jpg,.jpeg,.png">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click para subir o arrastra aqu√≠</p>
          </div>
          <div class="file-list" id="prosocList"></div>
        </div>

        <div class="form-group">
          <label>Informaci√≥n bancaria</label>
          <div class="file-upload" id="bancoUpload">
            <input type="file" id="bancoFile" accept=".pdf,.jpg,.jpeg,.png">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click para subir o arrastra aqu√≠</p>
          </div>
          <div class="file-list" id="bancoList"></div>
        </div>

        <!-- Reglamentos y Pol√≠ticas -->
        <div class="section-title">
          <i class="fas fa-file-contract"></i>
          Reglamentos y Pol√≠ticas
        </div>

        <div class="form-group">
          <label for="reglamento">Reglamento interno del condominio</label>
          <p class="help-text">Puedes subir tu propio reglamento o usar una plantilla</p>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <button type="button" class="btn-add" style="flex: 1;" onclick="useTemplate('basico')">
              <i class="fas fa-file-alt"></i> Usar plantilla b√°sica
            </button>
            <button type="button" class="btn-add" style="flex: 1; background: var(--primary);" onclick="useTemplate('completo')">
              <i class="fas fa-file-contract"></i> Usar plantilla completa
            </button>
          </div>
          <div class="file-upload" id="reglamentoUpload">
            <input type="file" id="reglamentoFile" accept=".pdf,.doc,.docx">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>O sube tu propio reglamento</p>
            <p class="help-text">PDF, DOC o DOCX (m√°x 10MB)</p>
          </div>
          <div class="file-list" id="reglamentoList"></div>
          <div id="reglamentoTemplate" style="display: none; margin-top: 1rem;">
            <textarea id="reglamentoText" rows="10" placeholder="El reglamento aparecer√° aqu√≠..."></textarea>
          </div>
        </div>

        <div class="form-group">
          <label for="privacyPolicy">Pol√≠ticas de privacidad</label>
          <p class="help-text">Define c√≥mo se manejar√°n los datos personales de los residentes</p>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <button type="button" class="btn-add" style="flex: 1;" onclick="usePrivacyTemplate()">
              <i class="fas fa-shield-alt"></i> Usar plantilla de privacidad
            </button>
          </div>
          <textarea id="privacyPolicy" rows="8" placeholder="Define las pol√≠ticas de privacidad..."></textarea>
        </div>

        <!-- Patrimonios/Fondos -->
        <div class="section-title">
          <i class="fas fa-piggy-bank"></i>
          Patrimonios y Fondos
        </div>

        <div class="form-group">
          <label>Fondos disponibles</label>
          <p class="help-text">Agrega los fondos o patrimonios existentes del condominio</p>
          <div class="patrimony-list" id="patrimonyList">
            <div class="patrimony-item">
              <input type="text" placeholder="Nombre del fondo" data-patrimony-name>
              <input type="number" placeholder="Monto inicial" step="0.01" data-patrimony-amount>
              <button type="button" class="btn-remove" onclick="removePatrimony(this)">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <button type="button" class="btn-add" onclick="addPatrimony()">
            <i class="fas fa-plus"></i> Agregar fondo
          </button>
        </div>

        <div class="form-group">
          <label for="fondoIngresos">Fondo para Ingresos de Cuotas</label>
          <select id="fondoIngresos" name="fondoIngresos">
            <option value="">Seleccionar despu√©s</option>
          </select>
          <p class="help-text">El fondo seleccionado recibir√° autom√°ticamente los pagos de cuotas. Puedes cambiarlo despu√©s en Configuraci√≥n.</p>
        </div>

        <!-- Cuotas -->
        <div class="section-title">
          <i class="fas fa-dollar-sign"></i>
          Configuraci√≥n de Cuotas
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="monthlyFee">Cuota mensual ordinaria (MXN) *</label>
            <input type="number" id="monthlyFee" name="monthlyFee" min="0" step="0.01" required>
            <p class="help-text">Monto regular mensual por unidad</p>
          </div>

          <div class="form-group">
            <label for="extraordinaryFee">Cuota extraordinaria (MXN) <span class="optional">(opcional)</span></label>
            <input type="number" id="extraordinaryFee" name="extraordinaryFee" min="0" step="0.01">
            <p class="help-text">Para proyectos especiales</p>
          </div>
        </div>

        <div class="form-group">
          <label for="cutoffDay">D√≠a de corte mensual *</label>
          <input type="number" id="cutoffDay" name="cutoffDay" min="1" max="31" value="1" required>
          <p class="help-text">D√≠a del mes en que vencen las cuotas</p>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="paymentDueDays">D√≠as de gracia para pago *</label>
            <input type="number" id="paymentDueDays" name="paymentDueDays" min="0" max="30" value="5" required>
            <p class="help-text">D√≠as despu√©s del corte antes de aplicar mora</p>
          </div>

          <div class="form-group">
            <label for="lateFeePercent">Recargo por mora (%) *</label>
            <input type="number" id="lateFeePercent" name="lateFeePercent" min="0" max="100" step="0.1" value="2" required>
            <p class="help-text">Porcentaje de recargo mensual por mora</p>
          </div>
        </div>

        <div class="form-group">
          <label for="paymentPolicies">Pol√≠ticas de vencimiento de pagos</label>
          <p class="help-text">Define las reglas y consecuencias de pagos vencidos</p>
          <div style="margin-bottom: 1rem;">
            <button type="button" class="btn-add" onclick="usePaymentPolicyTemplate()">
              <i class="fas fa-receipt"></i> Usar plantilla de pol√≠ticas de pago
            </button>
          </div>
          <textarea id="paymentPolicies" rows="8" placeholder="Define las pol√≠ticas de vencimiento..."></textarea>
        </div>

        <button type="submit" class="btn" id="submitBtn">
          <i class="fas fa-check-circle"></i>
          Completar configuraci√≥n
        </button>
      </form>
    </div>
  </div>

  <script>
    const email = localStorage.getItem('onboarding_email');
    const buildingNameStorage = localStorage.getItem('building_name');
    const selectedPlan = localStorage.getItem('onboarding_plan');

    if (!email) {
      window.location.href = '/register';
    }

    // Pre-fill building name if available
    if (buildingNameStorage) {
      document.getElementById('buildingName').value = buildingNameStorage;
    }

    // Define plans with maxUnits
    const PLANS = {
      basico: { name: 'Plan B√°sico', maxUnits: 20 },
      profesional: { name: 'Plan Profesional', maxUnits: 50 },
      empresarial: { name: 'Plan Empresarial', maxUnits: 200 },
      personalizado: { name: 'Plan Personalizado', maxUnits: -1 }
    };

    // Get total units from plan or custom package
    let totalUnits = 20; // Default
    
    if (selectedPlan) {
      const customPackage = localStorage.getItem('custom_package');
      
      if (selectedPlan === 'personalizado' && customPackage) {
        // Use units from custom package
        const pkg = JSON.parse(customPackage);
        totalUnits = pkg.units || 20;
      } else if (PLANS[selectedPlan]) {
        // Use maxUnits from selected plan
        totalUnits = PLANS[selectedPlan].maxUnits;
      }
    }

    // Set the total units field (readonly)
    document.getElementById('totalUnits').value = totalUnits;

    // Update plan info display
    const planName = selectedPlan ? PLANS[selectedPlan]?.name || 'Plan Profesional' : 'Plan Profesional';
    const planUnitsText = totalUnits === -1 ? 'Ilimitadas' : `${totalUnits} unidades`;
    
    document.getElementById('planName').textContent = planName;
    document.getElementById('planUnits').textContent = planUnitsText;

    // File upload handlers
    function setupFileUpload(uploadId, inputId, listId) {
      const uploadDiv = document.getElementById(uploadId);
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);

      uploadDiv.addEventListener('click', () => input.click());

      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span><i class="fas fa-file"></i> ${file.name}</span>
            <button type="button" onclick="this.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          `;
          list.innerHTML = '';
          list.appendChild(fileItem);
        }
      });

      // Drag and drop
      uploadDiv.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadDiv.style.borderColor = 'var(--primary)';
      });

      uploadDiv.addEventListener('dragleave', () => {
        uploadDiv.style.borderColor = '#E5E7EB';
      });

      uploadDiv.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadDiv.style.borderColor = '#E5E7EB';
        const file = e.dataTransfer.files[0];
        if (file) {
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          input.files = dataTransfer.files;
          input.dispatchEvent(new Event('change'));
        }
      });
    }

    setupFileUpload('actaUpload', 'actaFile', 'actaList');
    setupFileUpload('prosocUpload', 'prosocFile', 'prosocList');
    setupFileUpload('bancoUpload', 'bancoFile', 'bancoList');
    setupFileUpload('reglamentoUpload', 'reglamentoFile', 'reglamentoList');

    // Patrimony management
    // Actualizar select de fondos
    function updateFondosSelect() {
      const fondoIngresosSelect = document.getElementById('fondoIngresos');
      const patrimonyItems = document.querySelectorAll('.patrimony-item');
      
      const currentValue = fondoIngresosSelect.value;
      fondoIngresosSelect.innerHTML = '<option value="">Seleccionar fondo...</option>';
      
      patrimonyItems.forEach((item, idx) => {
        const nameInput = item.querySelector('[data-patrimony-name]');
        const name = nameInput?.value || '';
        
        if (name.trim()) {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = name;
          fondoIngresosSelect.appendChild(option);
        }
      });
      
      if (currentValue) {
        fondoIngresosSelect.value = currentValue;
      }
    }

    function addPatrimony() {
      const list = document.getElementById('patrimonyList');
      const item = document.createElement('div');
      item.className = 'patrimony-item';
      item.innerHTML = `
        <input type="text" placeholder="Nombre del fondo" data-patrimony-name>
        <input type="number" placeholder="Monto inicial" step="0.01" data-patrimony-amount>
        <button type="button" class="btn-remove" onclick="removePatrimony(this)">
          <i class="fas fa-times"></i>
        </button>
      `;
      list.appendChild(item);
      
      const nameInput = item.querySelector('[data-patrimony-name]');
      nameInput.addEventListener('input', updateFondosSelect);
      updateFondosSelect();
    }

    function removePatrimony(btn) {
      const list = document.getElementById('patrimonyList');
      if (list.children.length > 1) {
        btn.parentElement.remove();
        updateFondosSelect();
      }
    }
    
    // Inicializar listeners
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-patrimony-name]').forEach(input => {
        input.addEventListener('input', updateFondosSelect);
      });
      updateFondosSelect();
    });

    // Templates
    const TEMPLATES = {
      reglamento_basico: `REGLAMENTO INTERNO DEL CONDOMINIO

1. DISPOSICIONES GENERALES
- Este reglamento establece las normas de convivencia del condominio.
- Todos los residentes, propietarios e inquilinos deben cumplir estas disposiciones.
- El incumplimiento puede derivar en sanciones establecidas por la asamblea.

2. HORARIOS Y RUIDOS
- Horario de silencio: 22:00 hrs a 08:00 hrs
- Prohibidos ruidos molestos que perturben la tranquilidad
- Trabajos de construcci√≥n/remodelaci√≥n: Lunes a Viernes de 09:00 a 18:00 hrs

3. √ÅREAS COMUNES
- Respetar el uso de √°reas comunes
- Mantener limpieza y orden
- Reservar espacios seg√∫n procedimiento establecido

4. ESTACIONAMIENTO
- Respetar cajones asignados
- Prohibido estacionar en √°reas de circulaci√≥n
- Velocidad m√°xima: 10 km/h

5. MASCOTAS
- Permitidas con registro previo
- Obligatorio uso de correa en √°reas comunes
- Propietario responsable de limpieza
- Prohibido dejar mascotas sin supervisi√≥n

6. SEGURIDAD
- No proporcionar acceso a desconocidos
- Reportar actividades sospechosas
- Mantener cerradas puertas de acceso

7. PAGOS Y CUOTAS
- Pagar cuotas en tiempo y forma
- Notificar cambios de propietario/inquilino
- Mantener actualizada informaci√≥n de contacto`,

      reglamento_completo: `REGLAMENTO INTERNO DEL CONDOMINIO
Versi√≥n Completa

T√çTULO I - DISPOSICIONES GENERALES

Art√≠culo 1. Objeto y √Åmbito
El presente reglamento tiene por objeto establecer las normas de convivencia, uso y conservaci√≥n de las √°reas comunes y privativas del condominio, as√≠ como los derechos y obligaciones de propietarios, residentes y visitantes.

Art√≠culo 2. Obligatoriedad
Este reglamento es de observancia obligatoria para todos los propietarios, arrendatarios, residentes, visitantes y personal que preste servicios en el condominio.

T√çTULO II - ADMINISTRACI√ìN

Art√≠culo 3. √ìrganos de Administraci√≥n
- Asamblea General de Cond√≥minos
- Comit√© de Administraci√≥n
- Administrador

Art√≠culo 4. Cuotas de Mantenimiento
Los propietarios est√°n obligados a cubrir las cuotas ordinarias y extraordinarias aprobadas en asamblea, en las fechas establecidas.

T√çTULO III - USO DE √ÅREAS PRIVATIVAS Y COMUNES

Art√≠culo 5. √Åreas Privativas
- Uso exclusivo del propietario
- Prohibido realizar modificaciones exteriores sin autorizaci√≥n
- Mantener en buen estado de conservaci√≥n

Art√≠culo 6. √Åreas Comunes
- Accesos, pasillos, escaleras, elevadores
- Estacionamientos de visitas
- Salones, √°reas verdes, instalaciones deportivas
- Azoteas, cuartos de m√°quinas

Art√≠culo 7. Horarios
- Silencio: 22:00 a 08:00 hrs
- Construcci√≥n: Lunes a Viernes 09:00 a 18:00 hrs, S√°bados 10:00 a 14:00 hrs
- Uso de √°reas comunes: 07:00 a 22:00 hrs

T√çTULO IV - CONVIVENCIA

Art√≠culo 8. Ruidos y Molestias
Prohibido generar ruidos, vibraciones u olores que molesten a los vecinos.

Art√≠culo 9. Mascotas
- Permitidas con registro
- Obligatorio vacunaci√≥n y desparasitaci√≥n
- Uso de correa en √°reas comunes
- Prohibido en √°reas de juegos infantiles y albercas

Art√≠culo 10. Seguridad
- No dar acceso a desconocidos
- Registrar visitantes en control de acceso
- Reportar actividades sospechosas

T√çTULO V - SANCIONES

Art√≠culo 11. Tipos de Sanciones
- Amonestaci√≥n verbal
- Amonestaci√≥n escrita
- Multas econ√≥micas
- Suspensi√≥n de servicios
- Acciones legales

T√çTULO VI - DISPOSICIONES FINALES

Art√≠culo 12. Modificaciones
Este reglamento puede ser modificado por la Asamblea General con el voto favorable del 75% de los cond√≥minos.`,

      privacidad: `POL√çTICAS DE PRIVACIDAD Y PROTECCI√ìN DE DATOS

√öltima actualizaci√≥n: ${new Date().toLocaleDateString('es-MX')}

1. RESPONSABLE DEL TRATAMIENTO
El condominio es responsable del tratamiento de los datos personales recabados.

2. DATOS RECOPILADOS
- Datos de identificaci√≥n (nombre, domicilio, tel√©fono, email)
- Datos patrimoniales (estado de cuenta, pagos)
- Datos de veh√≠culos y mascotas
- Registros de acceso y visitantes

3. FINALIDADES
- Administraci√≥n del condominio
- Comunicaci√≥n con residentes
- Cobranza de cuotas
- Seguridad del inmueble
- Cumplimiento de obligaciones legales

4. COMPARTICI√ìN DE DATOS
Los datos personales no ser√°n compartidos con terceros, excepto:
- Autoridades competentes cuando sea legalmente requerido
- Proveedores de servicios bajo acuerdos de confidencialidad

5. MEDIDAS DE SEGURIDAD
Se implementan medidas de seguridad f√≠sicas, t√©cnicas y administrativas para proteger los datos personales.

6. DERECHOS ARCO
Los titulares tienen derecho a:
- Acceder a sus datos personales
- Rectificar datos inexactos
- Cancelar datos cuando corresponda
- Oponerse al tratamiento

7. RETENCI√ìN
Los datos se conservar√°n durante el tiempo necesario para cumplir las finalidades y obligaciones legales.

8. CONTACTO
Para ejercer derechos ARCO o consultas sobre privacidad, contactar al administrador del condominio.`,

      pago_vencimiento: `POL√çTICAS DE VENCIMIENTO Y MORA EN PAGOS

1. FECHAS DE PAGO
- Las cuotas de mantenimiento vencen el d√≠a [D√çA] de cada mes
- Plazo de gracia: [D√çAS] d√≠as naturales sin recargo
- Despu√©s del plazo de gracia se aplican recargos

2. RECARGOS POR MORA
- Tasa de recargo: [PORCENTAJE]% mensual sobre saldo vencido
- El recargo se aplica autom√°ticamente
- Se calculan intereses sobre intereses vencidos

3. CONSECUENCIAS DE FALTA DE PAGO

30 d√≠as de atraso:
- Recordatorio por email y/o tel√©fono
- Suspensi√≥n de acceso a √°reas comunes recreativas

60 d√≠as de atraso:
- Notificaci√≥n formal por escrito
- Suspensi√≥n de servicios no esenciales
- Inicio de proceso de cobranza administrativa

90 d√≠as de atraso:
- Citatorio a asamblea de cond√≥minos
- Inicio de procedimientos legales
- Posible embargo de unidad

4. CONVENIOS DE PAGO
- Disponibles para deudas mayores a 3 meses
- Requieren autorizaci√≥n del comit√©
- Incluyen plan de pagos con calendario definido
- Pago de gastos administrativos adicionales

5. ACLARACIONES
- Plazo de 5 d√≠as h√°biles para presentar aclaraciones
- Presentar comprobantes de pago
- Respuesta en m√°ximo 10 d√≠as h√°biles

6. SUSPENSI√ìN DE SERVICIOS
Servicios esenciales (agua, luz com√∫n, acceso b√°sico) no se suspenden por ley.
Servicios suspendibles: √°reas recreativas, eventos, gym, alberca, salones.

7. REINSTALACI√ìN
Para reinstalar servicios suspendidos:
- Pago total de adeudo y recargos
- Pago de gastos de reconexi√≥n
- Firma de compromiso de pago puntual

8. RESPONSABILIDAD
El propietario es responsable del pago a√∫n si la unidad est√° rentada.
En caso de venta, debe notificar y liquidar adeudos.`
    };

    function useTemplate(type) {
      const textarea = document.getElementById('reglamentoText');
      const templateDiv = document.getElementById('reglamentoTemplate');
      
      if (type === 'basico') {
        textarea.value = TEMPLATES.reglamento_basico;
      } else if (type === 'completo') {
        textarea.value = TEMPLATES.reglamento_completo;
      }
      
      templateDiv.style.display = 'block';
    }

    function usePrivacyTemplate() {
      document.getElementById('privacyPolicy').value = TEMPLATES.privacidad;
    }

    function usePaymentPolicyTemplate() {
      const cutoffDay = document.getElementById('cutoffDay').value || '[D√çA]';
      const dueDays = document.getElementById('paymentDueDays').value || '[D√çAS]';
      const lateFee = document.getElementById('lateFeePercent').value || '[PORCENTAJE]';
      
      let template = TEMPLATES.pago_vencimiento;
      template = template.replace('[D√çA]', cutoffDay);
      template = template.replace('[D√çAS]', dueDays);
      template = template.replace('[PORCENTAJE]', lateFee);
      
      document.getElementById('paymentPolicies').value = template;
    }

    // Generar numeraci√≥n de departamentos
    function generateDepartmentNumbers(totalUnits, totalFloors, style) {
      if (!totalUnits || !totalFloors || !style) return [];
      
      const deptsPerFloor = Math.ceil(totalUnits / totalFloors);
      const departments = [];
      
      for (let floor = 1; floor <= totalFloors; floor++) {
        for (let unit = 1; unit <= deptsPerFloor; unit++) {
          if (departments.length >= totalUnits) break;
          
          let deptNumber;
          if (style === 'dash') {
            deptNumber = `${floor}-${unit}`;
          } else if (style === 'continuous') {
            deptNumber = `${floor}${String(unit).padStart(2, '0')}`;
          }
          
          departments.push(deptNumber);
        }
      }
      
      return departments;
    }

    // Actualizar vista previa
    function updateDepartmentPreview() {
      const totalUnits = parseInt(document.getElementById('totalUnits').value);
      const totalFloors = parseInt(document.getElementById('totalFloors').value);
      const style = document.getElementById('numberingStyle').value;
      
      const preview = document.getElementById('departmentPreview');
      const previewDist = document.getElementById('previewDistribution');
      const previewDepts = document.getElementById('previewDepartments');
      
      if (!totalUnits || !totalFloors || !style) {
        preview.style.display = 'none';
        return;
      }
      
      const deptsPerFloor = Math.ceil(totalUnits / totalFloors);
      const departments = generateDepartmentNumbers(totalUnits, totalFloors, style);
      
      previewDist.textContent = `${totalFloors} pisos √ó ${deptsPerFloor} deptos/piso = ${departments.length} departamentos`;
      
      // Mostrar primeros 10 como ejemplo
      const examples = departments.slice(0, 10);
      previewDepts.innerHTML = examples.map(dept => 
        `<span style="background: var(--primary); color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500;">${dept}</span>`
      ).join('');
      
      if (departments.length > 10) {
        previewDepts.innerHTML += `<span style="color: var(--gray); font-size: 0.875rem;">... y ${departments.length - 10} m√°s</span>`;
      }
      
      preview.style.display = 'block';
    }

    // Event listeners para actualizar preview
    document.addEventListener('DOMContentLoaded', () => {
      const totalFloors = document.getElementById('totalFloors');
      const numberingStyle = document.getElementById('numberingStyle');
      
      if (totalFloors) {
        totalFloors.addEventListener('input', updateDepartmentPreview);
      }
      
      if (numberingStyle) {
        numberingStyle.addEventListener('change', updateDepartmentPreview);
      }
    });

    // Form submission
    document.getElementById('setupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const alert = document.getElementById('alert');
      
      const password = document.getElementById('adminPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (password !== confirmPassword) {
        alert.className = 'alert error';
        alert.textContent = 'Las contrase√±as no coinciden';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Configurando...';

      // Collect patrimonies
      const patrimonies = [];
      document.querySelectorAll('.patrimony-item').forEach((item, index) => {
        const name = item.querySelector('[data-patrimony-name]').value;
        const amount = item.querySelector('[data-patrimony-amount]').value;
        if (name && amount) {
          patrimonies.push({ name, amount: parseFloat(amount), index });
        }
      });

      // Actualizar selector de fondo de ingresos
      const fondoIngresosSelect = document.getElementById('fondoIngresos');
      fondoIngresosSelect.innerHTML = '<option value="">Seleccionar fondo...</option>';
      patrimonies.forEach((p, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = p.name;
        fondoIngresosSelect.appendChild(option);
      });
      
      // Generar departamentos con la numeraci√≥n seleccionada
      const totalUnits = parseInt(document.getElementById('totalUnits').value);
      const totalFloors = parseInt(document.getElementById('totalFloors').value);
      const numberingStyle = document.getElementById('numberingStyle').value;
      
      if (!totalFloors || !numberingStyle) {
        alert.className = 'alert error';
        alert.textContent = 'Por favor define la cantidad de pisos y el estilo de numeraci√≥n';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Completar Configuraci√≥n';
        return;
      }
      
      const departments = generateDepartmentNumbers(totalUnits, totalFloors, numberingStyle);
      
      const data = {
        email,
        adminPassword: password,
        adminData: {
          name: document.getElementById('adminName').value,
          phone: document.getElementById('adminPhone').value
        },
        buildingData: {
          name: document.getElementById('buildingName').value,
          address: document.getElementById('address').value,
          totalUnits: parseInt(document.getElementById('totalUnits').value),
          type: document.getElementById('buildingType').value,
          totalFloors: totalFloors,
          numberingStyle: numberingStyle,
          departments: departments,
          monthlyFee: parseFloat(document.getElementById('monthlyFee').value),
          extraordinaryFee: parseFloat(document.getElementById('extraordinaryFee').value) || 0,
          cutoffDay: parseInt(document.getElementById('cutoffDay').value),
          paymentDueDays: parseInt(document.getElementById('paymentDueDays').value),
          lateFeePercent: parseFloat(document.getElementById('lateFeePercent').value),
          reglamento: document.getElementById('reglamentoText').value,
          privacyPolicy: document.getElementById('privacyPolicy').value,
          paymentPolicies: document.getElementById('paymentPolicies').value
        },
        patrimonies: patrimonies,
        fondoIngresosIndex: parseInt(document.getElementById('fondoIngresos').value) || 0
      };
      
      console.log('üè¢ Departamentos generados:', departments);

      try {
        const response = await fetch('/api/onboarding/complete-setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.ok) {
          alert.className = 'alert success';
          alert.textContent = '¬°Configuraci√≥n completada! Redirigiendo...';
          
          // Save credentials for activate page
          if (result.credentials) {
            localStorage.setItem('new_credentials', JSON.stringify(result.credentials));
          }
          
          // Clear onboarding data
          localStorage.removeItem('onboarding_email');
          localStorage.removeItem('onboarding_plan');
          localStorage.removeItem('building_name');
          localStorage.removeItem('custom_package');
          
          setTimeout(() => {
            window.location.href = '/activate';
          }, 2000);
        } else {
          throw new Error(result.msg || 'Error en la configuraci√≥n');
        }
      } catch (error) {
        alert.className = 'alert error';
        alert.textContent = error.message;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Completar configuraci√≥n';
      }
    });
  </script>
</body>
</html>
