<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estado de Cuenta - ChispartBuilding</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      padding: 2rem;
      background: white;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid #4F46E5;
    }

    .header h1 {
      color: #1F2937;
      margin-bottom: 0.5rem;
    }

    .header .subtitle {
      color: #6B7280;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
      background: #F9FAFB;
      padding: 1.5rem;
      border-radius: 0.5rem;
    }

    .info-item {
      padding: 0.5rem 0;
    }

    .info-label {
      font-weight: bold;
      color: #4B5563;
      font-size: 0.875rem;
    }

    .info-value {
      color: #1F2937;
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 2rem 0;
    }

    thead {
      background: #4F46E5;
      color: white;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #E5E7EB;
    }

    tbody tr:nth-child(even) {
      background: #F9FAFB;
    }

    .total-row {
      background: #EFF6FF !important;
      font-weight: bold;
      font-size: 1.125rem;
    }

    .pendiente {
      color: #F59E0B;
    }

    .pagado {
      color: #10B981;
    }

    .vencido {
      color: #EF4444;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 2rem;
    }

    .summary-card {
      background: #F9FAFB;
      padding: 1.5rem;
      border-radius: 0.5rem;
      text-align: center;
      border: 2px solid #E5E7EB;
    }

    .summary-card h3 {
      color: #6B7280;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .summary-card .amount {
      color: #1F2937;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .footer {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 2px solid #E5E7EB;
      text-align: center;
      color: #6B7280;
      font-size: 0.875rem;
    }

    .no-print {
      margin-bottom: 2rem;
      text-align: center;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      background: #4F46E5;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      margin: 0 0.5rem;
    }

    .btn:hover {
      background: #4338CA;
    }

    .btn-secondary {
      background: #6B7280;
    }

    @media print {
      .no-print {
        display: none !important;
      }

      body {
        padding: 0;
      }

      @page {
        margin: 1cm;
      }
    }
  </style>
  <script src="/config.js"></script>
</head>
<body>
  <div class="no-print">
    <button class="btn" onclick="window.print()">
      <i class="fas fa-file-pdf"></i> Descargar PDF
    </button>
    <button class="btn btn-secondary" onclick="window.close()">
      <i class="fas fa-times"></i> Cerrar
    </button>
  </div>

  <div class="header">
    <h1>Estado de Cuenta</h1>
    <p class="subtitle" id="periodo"></p>
  </div>

  <div class="info-grid">
    <div class="info-item">
      <div class="info-label">Edificio</div>
      <div class="info-value" id="edificio-nombre"></div>
    </div>
    <div class="info-item">
      <div class="info-label">Direcci√≥n</div>
      <div class="info-value" id="edificio-direccion"></div>
    </div>
    <div class="info-item">
      <div class="info-label">Departamento</div>
      <div class="info-value" id="departamento"></div>
    </div>
    <div class="info-item">
      <div class="info-label">Fecha de Emisi√≥n</div>
      <div class="info-value" id="fecha-emision"></div>
    </div>
  </div>

  <h2 style="color: #1F2937; margin-bottom: 1rem;">Detalle de Cuotas</h2>
  
  <table id="cuotas-table">
    <thead>
      <tr>
        <th>Mes</th>
        <th>A√±o</th>
        <th>Monto</th>
        <th>Mora</th>
        <th>Total</th>
        <th>Estado</th>
        <th>Vencimiento</th>
      </tr>
    </thead>
    <tbody id="cuotas-tbody">
      <!-- Se llenar√° din√°micamente -->
    </tbody>
  </table>

  <div class="summary">
    <div class="summary-card">
      <h3>Total Pendiente</h3>
      <div class="amount" id="total-pendiente" style="color: #F59E0B;">$0</div>
    </div>
    <div class="summary-card">
      <h3>Total Pagado</h3>
      <div class="amount" id="total-pagado" style="color: #10B981;">$0</div>
    </div>
    <div class="summary-card">
      <h3>Mora Acumulada</h3>
      <div class="amount" id="total-mora" style="color: #EF4444;">$0</div>
    </div>
  </div>

  <div class="footer">
    <p>ChispartBuilding - Sistema de Administraci√≥n de Edificios</p>
    <p>Generado el <span id="fecha-generacion"></span></p>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const departamento = params.get('depto') || 'TODOS';
    const mes = params.get('mes');
    const anio = params.get('anio');

    async function cargarReporte() {
      try {
        const token = localStorage.getItem('edificio_token') || localStorage.getItem('token');
        
        if (!token) {
          console.error('No hay token disponible');
          alert('No se encontr√≥ el token de autenticaci√≥n');
          return;
        }

        const headers = {
          'Authorization': `Bearer ${token}`,
          'x-auth-token': token,
          'Content-Type': 'application/json'
        };

        console.log('üìä Cargando estado de cuenta para:', { departamento, mes, anio });

        // Cargar info del edificio
        const buildingRes = await fetch('/api/onboarding/building-info', { headers });
        
        if (buildingRes.ok) {
          const buildingData = await buildingRes.json();
          const info = buildingData.buildingInfo || {};
          
          document.getElementById('edificio-nombre').textContent = info.nombre || 'N/A';
          document.getElementById('edificio-direccion').textContent = info.direccion || 'N/A';
        } else {
          console.error('Error cargando info edificio:', await buildingRes.text());
        }

        // Cargar cuotas
        let url = '/api/cuotas';
        const queryParams = new URLSearchParams();
        
        if (mes) queryParams.append('mes', mes);
        if (anio) queryParams.append('anio', anio);
        
        if (queryParams.toString()) {
          url += '?' + queryParams.toString();
        }

        console.log('üìã Cargando cuotas desde:', url);
        const cuotasRes = await fetch(url, { headers });

        if (cuotasRes.ok) {
          const cuotasData = await cuotasRes.json();
          let cuotas = cuotasData.cuotas || [];
          
          console.log('‚úÖ Cuotas cargadas:', cuotas.length);
          
          // Filtrar por departamento si no es TODOS
          if (departamento !== 'TODOS') {
            cuotas = cuotas.filter(c => c.departamento === departamento);
            console.log('üîç Cuotas filtradas por depto:', cuotas.length);
          }

          renderCuotas(cuotas);
        } else {
          console.error('Error cargando cuotas:', await cuotasRes.text());
        }

        // Establecer fechas
        const periodoTexto = mes && anio ? `${mes} ${anio}` : 'Todos los periodos';
        document.getElementById('periodo').textContent = periodoTexto;
        document.getElementById('departamento').textContent = departamento;
        document.getElementById('fecha-emision').textContent = new Date().toLocaleDateString('es-MX');
        document.getElementById('fecha-generacion').textContent = new Date().toLocaleString('es-MX');

        console.log('‚úÖ Reporte cargado correctamente');

      } catch (error) {
        console.error('‚ùå Error cargando reporte:', error);
        alert('Error al cargar el reporte. Revisa la consola para m√°s detalles.');
      }
    }

    function renderCuotas(cuotas) {
      const tbody = document.getElementById('cuotas-tbody');
      tbody.innerHTML = '';

      if (cuotas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6B7280;">No hay cuotas registradas para este periodo</td></tr>';
        return;
      }

      let totalPendiente = 0;
      let totalPagado = 0;
      let totalMora = 0;

      cuotas.forEach(cuota => {
        const monto = parseFloat(cuota.monto || 0);
        const mora = parseFloat(cuota.monto_mora || 0);
        const total = monto + mora;

        const tr = document.createElement('tr');
        const isPagado = cuota.estado === 'PAGADO' || cuota.pagado === true;
        const isVencido = cuota.estado === 'VENCIDO' || cuota.vencida === true;
        
        const estadoClass = isPagado ? 'pagado' : (isVencido ? 'vencido' : 'pendiente');
        const estadoTexto = isPagado ? 'PAGADO' : (isVencido ? 'VENCIDO' : 'PENDIENTE');

        if (isPagado) {
          totalPagado += total;
        } else {
          totalPendiente += total;
          totalMora += mora;
        }

        tr.innerHTML = `
          <td>${cuota.mes || 'N/A'}</td>
          <td>${cuota.anio || 'N/A'}</td>
          <td>$${monto.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td>${mora > 0 ? '$' + mora.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
          <td><strong>$${total.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
          <td class="${estadoClass}"><strong>${estadoTexto}</strong></td>
          <td>${cuota.fecha_vencimiento ? new Date(cuota.fecha_vencimiento).toLocaleDateString('es-MX') : '-'}</td>
        `;

        tbody.appendChild(tr);
      });

      // Actualizar resumen
      document.getElementById('total-pendiente').textContent = `$${totalPendiente.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('total-pagado').textContent = `$${totalPagado.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('total-mora').textContent = `$${totalMora.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      console.log('üìä Totales calculados:', { totalPendiente, totalPagado, totalMora });
    }

    // Cargar al iniciar
    cargarReporte();
  </script>
</body>
</html>
