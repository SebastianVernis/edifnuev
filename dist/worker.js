var h=({base:a="",routes:r=[],...t}={})=>({__proto__:new Proxy({},{get:(e,s,o,n)=>(l,...u)=>r.push([s.toUpperCase?.(),RegExp(`^${(n=(a+l).replace(/\/+(\/|$)/g,"$1")).replace(/(\/?\.?):(\w+)\+/g,"($1(?<$2>*))").replace(/(\/?\.?):(\w+)/g,"($1(?<$2>[^$1/]+?))").replace(/\./g,"\\.").replace(/(\/?)\*/g,"($1.*)?")}/*$`),u,n])&&o}),routes:r,...t,async fetch(e,...s){let o,n,l=new URL(e.url),u=e.query={__proto__:null};for(let[c,f]of l.searchParams)u[c]=u[c]?[].concat(u[c],f):f;e:try{for(let c of t.before||[])if((o=await c(e.proxy??e,...s))!=null)break e;t:for(let[c,f,w,m]of r)if((c==e.method||c=="ALL")&&(n=l.pathname.match(f))){e.params=n.groups||{},e.route=m;for(let R of w)if((o=await R(e.proxy??e,...s))!=null)break t}}catch(c){if(!t.catch)throw c;o=await t.catch(c,e.proxy??e,...s)}try{for(let c of t.finally||[])o=await c(o,e.proxy??e,...s)??o}catch(c){if(!t.catch)throw c;o=await t.catch(c,e.proxy??e,...s)}return o}}),d=(a="text/plain; charset=utf-8",r)=>(t,e={})=>{if(t===void 0||t instanceof Response)return t;let s=new Response(r?.(t)??t,e.url?void 0:e);return s.headers.set("content-type",a),s},b=d("application/json; charset=utf-8",JSON.stringify);var x=d("text/plain; charset=utf-8",String),C=d("text/html"),T=d("image/jpeg"),O=d("image/png"),$=d("image/webp");var p=h(),i={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"};p.get("/api/validation/health",()=>new Response(JSON.stringify({status:"healthy",timestamp:new Date().toISOString(),environment:"cloudflare-workers"}),{headers:{...i,"Content-Type":"application/json"}}));p.post("/api/auth/login",async(a,r)=>{try{let t=await a.json(),{email:e,password:s}=t,n=await r.DB.prepare("SELECT * FROM usuarios WHERE email = ?").bind(e).first();if(!n)return new Response(JSON.stringify({success:!1,message:"Credenciales inv\xE1lidas"}),{status:401,headers:{...i,"Content-Type":"application/json"}});if(!(s===n.password))return new Response(JSON.stringify({success:!1,message:"Credenciales inv\xE1lidas"}),{status:401,headers:{...i,"Content-Type":"application/json"}});let u=await S({userId:n.id,email:n.email},r);return new Response(JSON.stringify({success:!0,token:u,user:{id:n.id,nombre:n.nombre,email:n.email,rol:n.rol,departamento:n.departamento}}),{headers:{...i,"Content-Type":"application/json"}})}catch(t){return new Response(JSON.stringify({success:!1,message:"Error en login",error:t.message}),{status:500,headers:{...i,"Content-Type":"application/json"}})}});p.get("/api/usuarios",async(a,r)=>{try{let t=await y(a,r);if(t)return t;let{results:e}=await r.DB.prepare("SELECT id, nombre, email, rol, departamento, activo FROM usuarios").all();return new Response(JSON.stringify({success:!0,usuarios:e}),{headers:{...i,"Content-Type":"application/json"}})}catch{return new Response(JSON.stringify({success:!1,message:"Error al obtener usuarios"}),{status:500,headers:{...i,"Content-Type":"application/json"}})}});p.get("/api/cuotas",async(a,r)=>{try{let t=await y(a,r);if(t)return t;let e=new URL(a.url),s=e.searchParams.get("mes"),o=e.searchParams.get("anio"),n="SELECT * FROM cuotas",l=[];s&&o&&(n+=" WHERE mes = ? AND anio = ?",l.push(s,o));let u=r.DB.prepare(n).bind(...l),{results:c}=await u.all();return new Response(JSON.stringify({success:!0,cuotas:c}),{headers:{...i,"Content-Type":"application/json"}})}catch{return new Response(JSON.stringify({success:!1,message:"Error al obtener cuotas"}),{status:500,headers:{...i,"Content-Type":"application/json"}})}});p.get("/*",async(a,r,t)=>{try{let s=new URL(a.url).pathname;(s==="/"||s==="/admin"||s==="/inquilino")&&(s="/index.html");let o=await r.ASSETS.fetch(new Request(`https://placeholder${s}`,a));return o.ok?o:new Response("Not Found",{status:404})}catch{return new Response("Internal Server Error",{status:500})}});p.options("*",()=>new Response(null,{headers:i}));async function y(a,r){let t=a.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return new Response(JSON.stringify({success:!1,message:"No autorizado"}),{status:401,headers:{...i,"Content-Type":"application/json"}});let e=t.substring(7);try{if(!await E(e,r))throw new Error("Invalid token");return null}catch{return new Response(JSON.stringify({success:!1,message:"Token inv\xE1lido"}),{status:401,headers:{...i,"Content-Type":"application/json"}})}}async function S(a,r){let t=r.JWT_SECRET||"edificio-admin-secret-key-2025",e=btoa(JSON.stringify({alg:"HS256",typ:"JWT"})),s=btoa(JSON.stringify({...a,exp:Date.now()+864e5})),o=await g(`${e}.${s}`,t);return`${e}.${s}.${o}`}async function E(a,r){try{let[t,e,s]=a.split("."),o=r.JWT_SECRET||"edificio-admin-secret-key-2025",n=await g(`${t}.${e}`,o);if(s!==n)return null;let l=JSON.parse(atob(e));return l.exp<Date.now()?null:l}catch{return null}}async function g(a,r){let t=new TextEncoder,e=await crypto.subtle.importKey("raw",t.encode(r),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),s=await crypto.subtle.sign("HMAC",e,t.encode(a));return btoa(String.fromCharCode(...new Uint8Array(s)))}var A={async fetch(a,r,t){return p.handle(a,r,t).catch(e=>new Response(JSON.stringify({success:!1,message:"Internal Server Error",error:e.message}),{status:500,headers:{...i,"Content-Type":"application/json"}}))}};export{A as default};
