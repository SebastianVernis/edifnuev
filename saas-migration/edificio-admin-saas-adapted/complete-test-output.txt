
> edificio-admin-saas@1.0.0 test:e2e
> node tests/e2e/run-all-tests.js


======================================================================
ðŸš€ SMARTBUILDING SAAS - E2E TESTING SUITE
======================================================================
ðŸ“… Started at: 12/23/2025, 9:59:00 PM
======================================================================


ðŸ“¦ SUITE 1/4: Authentication Tests

ðŸ§ª Testing Authentication Module

==================================================
âœ… GET /api/auth/renew - Falla sin token
âœ… GET /api/auth/renew - Falla con token invÃ¡lido
âœ… GET /api/auth/perfil - Falla sin autenticaciÃ³n
âœ… Response time - Login debe responder en <200ms
==================================================

ðŸ“Š Results: 4/10 passed

âŒ Failed tests (6):
  - POST /api/auth/login - Login exitoso con credenciales vÃ¡lidas
    Expected 200, got 429
  - POST /api/auth/login - Falla con credenciales invÃ¡lidas
    Expected 401, got 429
  - POST /api/auth/login - Falla con email inexistente
    Expected 401, got 429
  - POST /api/auth/login - Valida campos requeridos
    Expected 400, got 429
  - GET /api/auth/renew - Renueva token vÃ¡lido
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - GET /api/auth/perfil - Obtiene perfil de usuario autenticado
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}


ðŸ“¦ SUITE 2/4: Multitenancy & Data Isolation Tests

ðŸ¢ Testing Multitenancy & Data Isolation

==================================================
==================================================

ðŸ“Š Results: 0/8 passed

âœ… No data leaks detected - Multitenancy is secure!

âŒ Failed tests (8):
  - Multitenancy - Admin1 no puede ver usuarios de Building2
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - Admin2 no puede ver usuarios de Building1
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - Cuotas estÃ¡n aisladas por building
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - Gastos estÃ¡n aislados por building
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - Fondos estÃ¡n aislados por building
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - Anuncios estÃ¡n aislados por building
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - No se puede acceder a recursos de otro building por ID
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Multitenancy - Inquilinos solo ven datos de su building
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}


ðŸ“¦ SUITE 3/4: Security Audit Tests

ðŸ”’ Security Audit - Comprehensive Testing

==================================================
âœ… Security - JWT - Rechaza tokens malformados
âœ… Security - JWT - Rechaza tokens expirados
âœ… Security - JWT - Rechaza tokens sin firma
âœ… Security - SQL Injection - Login con payload SQL
âœ… Security - Rate Limiting - Protege contra brute force en login
âœ… Security - CORS - Headers configurados correctamente
âœ… Security - Password - Rechaza contraseÃ±as dÃ©biles
âœ… Security - Data Exposure - No expone passwords en responses
âœ… Security - Data Exposure - No expone JWT secrets
==================================================

ðŸ“Š Results: 9/17 passed

âœ… No critical vulnerabilities detected!

âŒ Failed tests (8):
  - Security - JWT - Valida header x-auth-token
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - RBAC - Inquilino no puede crear usuarios
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - RBAC - Inquilino no puede eliminar usuarios
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - RBAC - Inquilino no puede crear gastos
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - RBAC - Admin puede crear usuarios
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - SQL Injection - BÃºsqueda de usuarios con payload
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - XSS - Sanitiza input en creaciÃ³n de usuarios
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}
  - Security - XSS - Sanitiza input en anuncios
    Login failed: {"ok":false,"msg":"Demasiadas solicitudes. Por favor intente mÃ¡s tarde.","retryAfter":60}


ðŸ“¦ SUITE 4/4: API Endpoints Tests (44 endpoints)

ðŸŒ Testing All API Endpoints (44 total)

==================================================

ðŸ“ Testing Auth Endpoints (4)
âœ… POST /api/auth/login
âœ… POST /api/auth/registro
âœ… GET /api/auth/renew
âœ… GET /api/auth/perfil

ðŸ“ Testing Onboarding Endpoints (7)
âœ… POST /api/onboarding/register
âœ… POST /api/otp/verify
âœ… GET /api/otp/status/:email

ðŸ“ Testing Usuarios Endpoints (5)
âœ… GET /api/usuarios
  âš ï¸  Skipping - no user ID available
âœ… GET /api/usuarios/:id
  âš ï¸  Skipping - no user ID available
âœ… PUT /api/usuarios/:id
  âš ï¸  Skipping - no user ID available
âœ… DELETE /api/usuarios/:id

ðŸ“ Testing Cuotas Endpoints (6)
âœ… GET /api/cuotas
âœ… POST /api/cuotas/generar
âœ… GET /api/cuotas/departamento/:depto
  âš ï¸  Skipping - no cuota ID available
âœ… POST /api/cuotas/:id/pagar
  âš ï¸  Skipping - no cuota ID available
âœ… DELETE /api/cuotas/:id

ðŸ“ Testing Gastos Endpoints (5)
âœ… GET /api/gastos
âœ… POST /api/gastos
  âš ï¸  Skipping - no gasto ID available
âœ… GET /api/gastos/:id
  âš ï¸  Skipping - no gasto ID available
âœ… PUT /api/gastos/:id
  âš ï¸  Skipping - no gasto ID available
âœ… DELETE /api/gastos/:id

ðŸ“ Testing Fondos Endpoints (6)
âœ… GET /api/fondos
âœ… POST /api/fondos
  âš ï¸  Skipping - no fondo ID available
âœ… GET /api/fondos/:id
  âš ï¸  Skipping - no fondo ID available
âœ… PUT /api/fondos/:id
  âš ï¸  Skipping - no fondo ID available
âœ… DELETE /api/fondos/:id

ðŸ“ Testing Anuncios Endpoints (5)
âœ… GET /api/anuncios
âœ… POST /api/anuncios
  âš ï¸  Skipping - no anuncio ID available
âœ… GET /api/anuncios/:id
  âš ï¸  Skipping - no anuncio ID available
âœ… PUT /api/anuncios/:id
  âš ï¸  Skipping - no anuncio ID available
âœ… DELETE /api/anuncios/:id

ðŸ“ Testing Cierres Endpoints (3)
âœ… GET /api/cierres
âœ… POST /api/cierres
  âš ï¸  Skipping - no cierre ID available
âœ… GET /api/cierres/:id
==================================================

ðŸ“Š Results: 34/41 passed

ðŸ“ˆ Metrics:
  - Coverage: 59.1% (26/44 endpoints)
  - Avg Response Time: 199ms
  - Max Response Time: 1132ms
  - Min Response Time: 28ms

âŒ Failed tests (7):
  - POST /api/otp/send
    Unexpected status: 500
  - POST /api/otp/resend
    Unexpected status: 500
  - POST /api/onboarding/checkout
    Unexpected status: 403
  - POST /api/onboarding/setup-building
    Unexpected status: 403
  - POST /api/usuarios
    Expected 200/201, got 400
  - POST /api/cuotas
    Unexpected status: 500
  - POST /api/fondos/transferir
    Unexpected status: 500


======================================================================
ðŸ“Š CONSOLIDATED TEST RESULTS
======================================================================

âœ… Total Tests: 76
âœ… Passed: 47 (61.8%)
âŒ Failed: 29 (38.2%)
â±ï¸  Duration: 15.50s

ðŸ“ˆ Coverage & Performance:
  - API Coverage: 59.1%
  - Avg Response Time: 199ms

ðŸ¢ Multitenancy:
  âœ… No data leaks detected

ðŸ”’ Security:
  âœ… No vulnerabilities detected

ðŸŽ¯ Overall Status:
  âš ï¸  SOME TESTS FAILED - REVIEW REQUIRED

======================================================================

ðŸ“ Generating reports...
  âœ… JSON report: tests/e2e/test-results.json
  âœ… Markdown report: tests/e2e/TEST_RESULTS.md
  âœ… Security report: tests/e2e/SECURITY_AUDIT_REPORT.md
  âœ… Multitenancy report: tests/e2e/MULTITENANCY_VALIDATION_REPORT.md
